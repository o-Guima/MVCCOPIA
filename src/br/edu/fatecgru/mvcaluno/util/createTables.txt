-- DROP TABLES (ordem para respeitar FK)
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS matriculaDisciplina;
DROP TABLE IF EXISTS matricula;
DROP TABLE IF EXISTS disciplina;
DROP TABLE IF EXISTS curso;
DROP TABLE IF EXISTS aluno;

SET FOREIGN_KEY_CHECKS = 1;



-- TABELA ALUNO
CREATE TABLE aluno (
    idAluno INT AUTO_INCREMENT PRIMARY KEY,
    ra VARCHAR(20) NOT NULL UNIQUE,
    nome VARCHAR(100) NOT NULL,
    dataNascimento DATE NOT NULL,
    cpf VARCHAR(14) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    endereco VARCHAR(200) NOT NULL,
    municipio VARCHAR(100) NOT NULL,
    uf CHAR(2) NOT NULL,
    celular VARCHAR(15) NOT NULL,
    ativo BOOLEAN NOT NULL
);

-- TABELA CURSO
CREATE TABLE curso (
    idCurso INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    campus VARCHAR(100) NOT NULL,
    periodo VARCHAR(20) NOT NULL,
    duracao INT NOT NULL,
    ativo BOOLEAN NOT NULL
);

-- TABELA DISCIPLINA
CREATE TABLE disciplina (
    idDisciplina INT AUTO_INCREMENT PRIMARY KEY,
    idCurso INT NOT NULL,
    nome VARCHAR(100) NOT NULL,
    semestre INT NOT NULL,
    ativo BOOLEAN NOT NULL,
    FOREIGN KEY (idCurso) REFERENCES curso(idCurso)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT unq_disciplina UNIQUE (idCurso, nome)
);

-- TABELA MATRICULA
CREATE TABLE matricula (
    idMatricula INT AUTO_INCREMENT PRIMARY KEY,
    idAluno INT NOT NULL,
    idCurso INT NOT NULL,
    semestreInicio VARCHAR(20) NOT NULL,
    ativo BOOLEAN NOT NULL DEFAULT TRUE,
    FOREIGN KEY (idAluno) REFERENCES aluno(idAluno)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (idCurso) REFERENCES curso(idCurso)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

-- TABELA MATRICULADISCIPLINA 
CREATE TABLE matriculaDisciplina (
    idMatriculaDisciplina INT AUTO_INCREMENT PRIMARY KEY,
    idMatricula INT NOT NULL,
    idDisciplina INT NOT NULL,
    semestreCursado VARCHAR(20) NOT NULL,
    faltas INT NOT NULL,
    nota DOUBLE NOT NULL,
    status ENUM('Cursando', 'Aprovado', 'Reprovado') DEFAULT 'Cursando',
    ativo BOOLEAN NOT NULL DEFAULT TRUE,
 	FOREIGN KEY (idMatricula) REFERENCES matricula(idMatricula)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (idDisciplina) REFERENCES disciplina(idDisciplina)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT unq_matriculadisciplina UNIQUE (idMatricula, idDisciplina, semestreCursado) -- AJUDA A EVITAR DUPLICIDADE EM UM MESMO SEMESTRE LETIVO
);
